- name: Get service CIDR from variable
  set_fact:
    service_cidr_base: "{{ lookup('vars', 'SERVICE_CIDR_' ~ worker_type.index) }}"

- name: Get pod CIDR from variable
  set_fact:
    pod_cidr: "{{ lookup('vars', 'POD_CIDR_' ~ worker_type.index) }}"

- name: Validate service CIDR format
  assert:
    that:
      - service_cidr_base is defined
      - service_cidr_base is string
      - service_cidr_base is match('^[0-9.]+/[0-9]+$')
    fail_msg: "service_cidr appears malformed or undefined: {{ service_cidr_base | default('undefined') }}"

- name: Validate pod CIDR format
  assert:
    that:
      - pod_cidr is defined
      - pod_cidr is string
      - pod_cidr is match('^[0-9.]+/[0-9]+$')
    fail_msg: "pod_cidr appears malformed or undefined: {{ pod_cidr | default('undefined') }}"

- name: Apply BGP Configuration
  kubernetes.core.k8s:
    kubeconfig: "{{ lookup('vars', 'KUBECONFIG_' ~ worker_type.index) }}"
    state: present
    template: bgpconfiguration.yaml.j2
  vars:
    asnumber: "6{{ worker_type.index }}012"
    bgp_config_name: default
    service_cidr: "{{ service_cidr_base }}"
